---
phase: 03-pdf-reading
plan: 01
type: execute
---

<objective>
Add PDF.js library to extension and implement core PDF text extraction functionality.

Purpose: Enable the extension to extract text from PDF documents viewed in the browser.
Output: PDF.js integrated, PDF detection working, text extraction functional.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-pdf-reading/DISCOVERY.md
@.planning/phases/02-multi-language-foundation/02-02-SUMMARY.md

# Key files to modify:
@extension/manifest.json
@extension/content.js

**Tech stack available:**
- chrome.storage.sync for configuration
- chrome.i18n.detectLanguage() for language detection
- getEffectiveLanguage() helper for language code retrieval

**Established patterns:**
- analyzeArticle() function handles article → API → display flow
- detectArticle() returns DOM element with text content
- apiFetch() wrapper handles backend communication

**Constraining decisions:**
- Phase 02-02: All API calls include language parameter
- Phase 01-01: chrome.storage.sync for extension configuration

**From DISCOVERY.md:**
- Use PDF.js bundled in extension (Option 1)
- Detect PDFs by URL or content-type
- Extract text client-side for privacy
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add PDF.js library to extension</name>
  <files>extension/lib/pdf.min.mjs, extension/lib/pdf.worker.min.mjs, extension/manifest.json</files>
  <action>
Download PDF.js release (v4.x stable) and add to extension:
1. Create `extension/lib/` directory
2. Download `pdf.min.mjs` and `pdf.worker.min.mjs` from PDF.js releases
3. Update manifest.json to include the library in web_accessible_resources (needed for worker)

Use the latest stable v4.x release. The worker file must be web-accessible for PDF.js to load it.

Note: Do NOT use v5.x as it requires Promise.withResolvers (Node 22+/Chrome 119+).
  </action>
  <verify>
Files exist:
- extension/lib/pdf.min.mjs
- extension/lib/pdf.worker.min.mjs
manifest.json includes web_accessible_resources for the worker
  </verify>
  <done>PDF.js library files present in extension/lib/, manifest updated</done>
</task>

<task type="auto">
  <name>Task 2: Implement PDF detection and text extraction</name>
  <files>extension/content.js</files>
  <action>
Add PDF handling functions to content.js:

1. Add `isPdfContext()` function:
   - Check if current URL ends with `.pdf`
   - Check if page contains `<embed type="application/pdf">`
   - Check if Chrome's PDF viewer is active (look for `pdf-viewer` or `viewer.html` patterns)

2. Add `extractPdfText(url)` function:
   - Import PDF.js dynamically (avoid loading for non-PDF pages)
   - Configure worker path using chrome.runtime.getURL()
   - Load PDF from current page URL
   - Extract text from all pages (up to MAX_PDF_PAGES = 50)
   - Join text with page separators
   - Return extracted text string

3. Handle errors gracefully:
   - CORS errors (some PDFs may block extension access)
   - Password-protected PDFs
   - Scanned PDFs (no text layer - show helpful message)

Pattern to follow from existing code:
```javascript
// Similar to detectLanguage() - async with graceful fallback
async function extractPdfText(url) {
  try {
    // PDF.js extraction logic
  } catch (error) {
    console.error('PDF extraction error:', error);
    return null;
  }
}
```

Do NOT modify analyzeArticle() yet - that's in Plan 02.
  </action>
  <verify>
In browser console on a PDF page:
1. isPdfContext() returns true
2. extractPdfText(location.href) returns text string (or null with error logged)
  </verify>
  <done>isPdfContext() detects PDF pages, extractPdfText() extracts text from PDFs</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] extension/lib/pdf.min.mjs exists and is valid ES module
- [ ] extension/lib/pdf.worker.min.mjs exists
- [ ] manifest.json has web_accessible_resources entry
- [ ] isPdfContext() function exists in content.js
- [ ] extractPdfText() function exists in content.js
- [ ] Extension loads without errors (check chrome://extensions)
</verification>

<success_criteria>
- PDF.js library files added to extension
- Manifest updated for worker accessibility
- PDF detection function works
- Text extraction function works on test PDFs
- No console errors on regular (non-PDF) pages
</success_criteria>

<output>
After completion, create `.planning/phases/03-pdf-reading/03-01-SUMMARY.md`
</output>
