---
phase: 03-pdf-reading
plan: 02
type: execute
---

<objective>
Integrate PDF text extraction with the existing analysis flow and enable local PDF file support.

Purpose: Complete the PDF reading feature by connecting extraction to CEFR analysis.
Output: Users can analyze PDFs (local and online) with full CEFR level assessment.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-pdf-reading/DISCOVERY.md
@.planning/phases/03-pdf-reading/03-01-SUMMARY.md

# Key files to modify:
@extension/manifest.json
@extension/content.js

**Requires from 03-01:**
- isPdfContext() function
- extractPdfText() function
- PDF.js library in extension/lib/

**Established patterns:**
- analyzeArticle() handles article â†’ API â†’ display flow
- showBanner() for user feedback
- getEffectiveLanguage() for language code
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create analyzePdf() function and integrate with UI</name>
  <files>extension/content.js</files>
  <action>
Add analyzePdf() function that mirrors analyzeArticle() pattern:

1. Create `analyzePdf()` function:
   - Call showBanner('ðŸ”„ Extracting PDF text...', 'loading')
   - Call extractPdfText() from Plan 01
   - If extraction fails, show error banner with helpful message
   - Detect language using existing detectLanguage() function
   - Send to /analyze endpoint (same as articles)
   - Display results using existing updateMenuContent()

2. Modify the R/L button initialization:
   - In the button click handler, check isPdfContext() first
   - If PDF: call analyzePdf() instead of analyzeArticle()
   - Update button tooltip/title to indicate PDF support

3. Handle PDF-specific edge cases:
   - Very large PDFs: Limit to first 50 pages, show "(first 50 pages)" in banner
   - Empty text extraction: "This PDF appears to be scanned/image-only"
   - CORS blocked PDFs: "Cannot access this PDF due to security restrictions"

Pattern to follow:
```javascript
async function analyzePdf() {
  try {
    showBanner('ðŸ”„ Extracting PDF text...', 'loading');
    const text = await extractPdfText(window.location.href);
    if (!text || text.trim().length < 100) {
      showBanner('âŒ Could not extract text. PDF may be scanned/image-only.', 'error');
      return;
    }
    // Continue with language detection and analysis (same as analyzeArticle)
    ...
  } catch (error) {
    showBanner(`âŒ PDF error: ${error.message}`, 'error');
  }
}
```
  </action>
  <verify>
On a PDF page:
1. Click R/L button
2. Banner shows "Extracting PDF text..."
3. CEFR analysis appears in menu
  </verify>
  <done>analyzePdf() function works, R/L button triggers PDF analysis on PDF pages</done>
</task>

<task type="auto">
  <name>Task 2: Enable local PDF file access</name>
  <files>extension/manifest.json, extension/options.html, extension/options.js</files>
  <action>
Enable local file:// URL access:

1. Update manifest.json:
   - Add "file://*/*" to host_permissions array
   - This allows the extension to access local files when user enables it

2. Update options.html:
   - Add a note explaining that users need to enable "Allow access to file URLs" in Chrome's extension settings for local PDFs to work
   - Add a link/instructions to chrome://extensions page

3. Update options.js:
   - Add a check for file:// access (chrome.extension.isAllowedFileSchemeAccess)
   - Display status: "Local PDF access: Enabled/Disabled"
   - If disabled, show instructions to enable

Note: Chrome requires users to manually enable file:// access in extension settings. We cannot programmatically enable it.

The options page should clearly explain:
"To analyze local PDF files:
1. Go to chrome://extensions
2. Find 'Read & Learn' and click 'Details'
3. Enable 'Allow access to file URLs'"
  </action>
  <verify>
1. manifest.json includes "file://*/*" in host_permissions
2. Options page shows local PDF access status
3. Extension can be enabled for file:// URLs via Chrome settings
  </verify>
  <done>Manifest allows file:// access, options page shows status and instructions</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete PDF analysis feature - both online and local PDFs</what-built>
  <how-to-verify>
    1. Test online PDF:
       - Visit any online PDF (e.g., a research paper, government document)
       - Click the R/L button
       - Verify: Text extraction message appears, then CEFR analysis shows

    2. Test local PDF:
       - Go to chrome://extensions, find Read & Learn, click Details
       - Enable "Allow access to file URLs"
       - Open a local PDF file (File â†’ Open or drag to Chrome)
       - Click the R/L button
       - Verify: Analysis works on local file

    3. Test error handling:
       - Try a scanned/image-only PDF if available
       - Verify: Helpful error message appears

    4. Test regular pages still work:
       - Visit a regular article page
       - Click R/L button
       - Verify: Article analysis still works (no regression)
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] analyzePdf() function exists and works
- [ ] R/L button detects PDF context and calls analyzePdf()
- [ ] manifest.json has file://*/* in host_permissions
- [ ] Options page shows local PDF access instructions
- [ ] Online PDFs can be analyzed
- [ ] Local PDFs can be analyzed (when access enabled)
- [ ] Regular article analysis still works (no regression)
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Human verified PDF analysis works end-to-end
- No regression in article analysis
- Phase 3: PDF Reading complete
</success_criteria>

<output>
After completion, create `.planning/phases/03-pdf-reading/03-02-SUMMARY.md`:

# Phase 3 Plan 02: PDF UI Integration Summary

**[Substantive one-liner about what shipped]**

## Accomplishments
- [Key outcomes]

## Files Created/Modified
- [Files with descriptions]

## Decisions Made
- [Any runtime decisions]

## Issues Encountered
- [Problems and resolutions]

## Next Phase Readiness
- Phase 3: PDF Reading complete
- Ready for Phase 4: Code Quality
</output>
