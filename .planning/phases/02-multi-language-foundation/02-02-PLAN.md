---
phase: 02-multi-language-foundation
plan: 02
type: execute
---

<objective>
Add automatic language detection and manual language selection to the Chrome extension.

Purpose: Enable users to analyze articles in any EU language with auto-detection and manual override capability.
Output: Extension that detects article language automatically, allows manual override, and passes language to backend.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-multi-language-foundation/02-01-SUMMARY.md

**Tech stack available:**
- Chrome extension MV3 with chrome.storage.sync
- chrome.i18n.detectLanguage() API (CLD-based, built into Chrome)
- Options page pattern established in Phase 1

**Established patterns:**
- chrome.storage.sync for extension configuration
- Options page for user settings
- sanitizeForDisplay() for XSS-safe rendering
- apiFetch() for backend communication via background.js

**Key files:**
@extension/content.js
@extension/options.html
@extension/options.js
@extension/manifest.json

**Constraining decisions:**
- Phase 01-01: chrome.storage.sync for MV3 service worker compatibility
- Phase 01-02: textContent for XSS prevention

**Current state:**
- `isFrench()` function (line 625-637) uses hardcoded French word list
- Analysis flow rejects non-French text
- All API calls hardcode `language: 'fr'`
- No language selection UI exists
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace isFrench() with chrome.i18n.detectLanguage()</name>
  <files>extension/content.js</files>
  <action>
  Replace the hardcoded `isFrench()` function with a proper language detection function using Chrome's built-in API:

  1. Add supported languages constant (mirror backend):
  ```javascript
  const SUPPORTED_LANGUAGES = {
    bg: 'Bulgarian', hr: 'Croatian', cs: 'Czech', da: 'Danish',
    nl: 'Dutch', en: 'English', et: 'Estonian', fi: 'Finnish',
    fr: 'French', de: 'German', el: 'Greek', hu: 'Hungarian',
    ga: 'Irish', it: 'Italian', lv: 'Latvian', lt: 'Lithuanian',
    mt: 'Maltese', pl: 'Polish', pt: 'Portuguese', ro: 'Romanian',
    sk: 'Slovak', sl: 'Slovenian', es: 'Spanish', sv: 'Swedish'
  };
  ```

  2. Replace `isFrench()` with `detectLanguage()`:
  ```javascript
  async function detectLanguage(text) {
    return new Promise((resolve) => {
      chrome.i18n.detectLanguage(text, (result) => {
        if (result && result.languages && result.languages.length > 0) {
          const detected = result.languages[0];
          const langCode = detected.language.toLowerCase().split('-')[0]; // Handle 'pt-BR' -> 'pt'
          if (SUPPORTED_LANGUAGES[langCode]) {
            resolve({
              code: langCode,
              name: SUPPORTED_LANGUAGES[langCode],
              confidence: detected.percentage,
              isReliable: result.isReliable
            });
            return;
          }
        }
        resolve(null); // Unsupported or undetected
      });
    });
  }
  ```

  3. Add state variable for detected/selected language:
  ```javascript
  let currentLanguage = null; // { code: 'fr', name: 'French', ... }
  ```

  4. Update `analyzeArticle()` to use detection instead of `isFrench()`:
  - Call `detectLanguage(text)` after detecting article
  - If unsupported language, show error with detected language name
  - Store detected language in `currentLanguage`
  - Pass `language: currentLanguage.code` to `/analyze` endpoint

  Do NOT add manual override UI yet - that's Task 2.
  </action>
  <verify>
  1. Load extension on a French article - should detect "French" and analyze
  2. Load extension on a Spanish article - should detect "Spanish" and analyze
  3. Load extension on a Japanese article - should show "Unsupported language" error
  </verify>
  <done>Language auto-detection works for all 24 EU languages, unsupported languages show clear error message</done>
</task>

<task type="auto">
  <name>Task 2: Add language selector to extension UI</name>
  <files>extension/content.js</files>
  <action>
  Add a language dropdown to the R/L menu for manual override:

  1. Add to state management (near line 79):
  ```javascript
  // Load manual language override from localStorage
  let manualLanguageOverride = localStorage.getItem('rl-language-override') || null;
  ```

  2. Create language selector HTML (add to `renderAnalysisView()` or create new function):
  ```javascript
  function renderLanguageSelector() {
    const current = manualLanguageOverride || (currentLanguage ? currentLanguage.code : 'auto');
    const detectedInfo = currentLanguage ? ` (detected: ${currentLanguage.name})` : '';

    let options = '<option value="auto">Auto-detect' + detectedInfo + '</option>';
    for (const [code, name] of Object.entries(SUPPORTED_LANGUAGES)) {
      const selected = current === code ? ' selected' : '';
      options += `<option value="${code}"${selected}>${name}</option>`;
    }

    return `
      <div style="margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid rgba(255,255,255,0.1);">
        <label style="display: block; font-size: 11px; color: #888; margin-bottom: 4px;">Article Language</label>
        <select id="rl-language-select" style="width: 100%; padding: 6px; border-radius: 4px; border: 1px solid #444; background: #333; color: #fff; font-size: 13px;">
          ${options}
        </select>
      </div>
    `;
  }
  ```

  3. Add event listener for language selection (in `attachMenuListeners()`):
  ```javascript
  const langSelect = document.getElementById('rl-language-select');
  if (langSelect) {
    langSelect.addEventListener('change', (e) => {
      const value = e.target.value;
      if (value === 'auto') {
        manualLanguageOverride = null;
        localStorage.removeItem('rl-language-override');
      } else {
        manualLanguageOverride = value;
        localStorage.setItem('rl-language-override', value);
      }
      // Re-analyze if article was already analyzed
      if (currentAnalysis) {
        analyzeArticle();
      }
    });
  }
  ```

  4. Update `analyzeArticle()` to respect manual override:
  - If `manualLanguageOverride` is set, use it instead of auto-detection
  - Update banner message to show selected language name

  Use sanitizeForDisplay() or textContent for any dynamic text. Styling should match existing menu aesthetic (dark theme, purple accents).
  </action>
  <verify>
  1. Open menu - language dropdown appears with "Auto-detect" selected
  2. Manually select "Spanish" - re-analyzes article as Spanish
  3. Reload page - manual selection persists
  4. Select "Auto-detect" - returns to auto-detection behavior
  </verify>
  <done>Language selector in menu, manual override persists, auto-detect shows detected language</done>
</task>

<task type="auto">
  <name>Task 3: Update all API calls to include language</name>
  <files>extension/content.js</files>
  <action>
  Update all backend API calls to pass the current language:

  1. Create helper function to get effective language:
  ```javascript
  function getEffectiveLanguage() {
    if (manualLanguageOverride) {
      return manualLanguageOverride;
    }
    return currentLanguage ? currentLanguage.code : 'fr'; // fallback to French
  }
  ```

  2. Update `/analyze` call (line 663-670):
  - Already updated in Task 1, ensure it uses `getEffectiveLanguage()`

  3. Update `/define` call (around line 888):
  ```javascript
  body: JSON.stringify({
    word: word,
    context: context,
    language: getEffectiveLanguage()
  })
  ```

  4. Update `/define-batch` call (if used):
  ```javascript
  body: JSON.stringify({
    words: words,
    language: getEffectiveLanguage()
  })
  ```

  5. Update `/deck/add` call (around line 960):
  ```javascript
  body: JSON.stringify({
    word: selectedText,
    phrase: phrase,
    contextSentence: contextSentence,
    // ... other fields ...
    language: getEffectiveLanguage()
  })
  ```

  6. Update banner messages to show language name instead of hardcoded "French":
  - Line 657: "This doesn't appear to be French text" -> use detected language
  - Line 661: "Analyzing French level..." -> "Analyzing {language} level..."
  </action>
  <verify>
  1. Analyze a Spanish article - backend receives language: 'es'
  2. Click a word to define - backend receives language: 'es'
  3. Add word to deck - card saved with language: 'es'
  4. Check banner messages show correct language name
  </verify>
  <done>All API calls include correct language parameter, UI messages show language name</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Multi-language support with auto-detection and manual override</what-built>
  <how-to-verify>
    1. Run: Start backend (npm start in translation-backend) and load extension
    2. Test French (default):
       - Visit a French article (e.g., lemonde.fr)
       - Click R/L button - should auto-detect "French"
       - Analyze article - should work as before
    3. Test Spanish:
       - Visit a Spanish article (e.g., elpais.com)
       - Click R/L button - should auto-detect "Spanish"
       - Analyze article - should return Spanish CEFR analysis
    4. Test manual override:
       - On any article, open menu and select different language
       - Click analyze - should analyze as selected language
       - Reload page - selection should persist
    5. Test word definition:
       - Enable selection mode on Spanish article
       - Click a Spanish word - should get Spanish definition
    6. Test unsupported language:
       - Visit a Japanese article
       - Should show "Unsupported language" error
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Language auto-detection works for EU languages
- [ ] Unsupported languages show clear error
- [ ] Manual language selector in menu
- [ ] Selection persists across page reloads
- [ ] All API calls pass language parameter
- [ ] French fallback works when detection fails
- [ ] Human verification approved
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Human verification approved
- Extension auto-detects article language
- Manual override available and persistent
- All API calls include language parameter
- No breaking changes to French-only workflow
</success_criteria>

<output>
After completion, create `.planning/phases/02-multi-language-foundation/02-02-SUMMARY.md` with:

# Phase 2 Plan 02: Extension Language Detection Summary

**[Substantive one-liner]**

## Accomplishments
- [Key outcomes]

## Files Created/Modified
- [List with descriptions]

## Decisions Made
- [Key decisions and rationale]

## Issues Encountered
- [Problems and resolutions, or "None"]

## Next Step
Phase 2: Multi-Language Foundation complete. Ready for Phase 3: PDF Reading.
</output>
