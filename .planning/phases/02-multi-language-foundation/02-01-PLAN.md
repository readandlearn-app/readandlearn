---
phase: 02-multi-language-foundation
plan: 01
type: execute
---

<objective>
Generalize backend prompts and API to support any EU CEFR language instead of hardcoded French.

Purpose: Enable the server to analyze and define words in any of the 24 EU official languages while maintaining the existing French functionality as default.
Output: Backend API that accepts a `language` parameter and generates language-appropriate Claude prompts.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-production-infrastructure/01-01-SUMMARY.md
@.planning/phases/01-production-infrastructure/01-02-SUMMARY.md
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/INTEGRATIONS.md

**Tech stack available:**
- Express.js backend with Claude API integration
- PostgreSQL with language column already in schema
- Input validation middleware pattern established

**Established patterns:**
- validateXxxRequest middleware for input validation
- Claude API call pattern with token tracking

**Key files:**
@translation-backend/server.js

**Constraining decisions:**
- Phase 01-01: Non-blocking API validation with graceful 503 degradation
- Phase 01-02: Input validation middleware pattern

**Current state:**
- `/analyze` endpoint: Hardcoded "French text" in Claude prompt (line 626-628)
- `/define` endpoint: Hardcoded "French word" in Claude prompt (line 798)
- `/define-batch` endpoint: Hardcoded "French words" in Claude prompt (line 990)
- `lookupDictionary()`: Only queries `french_dictionary` table (line 734)
- All endpoints accept `language` param but prompts ignore it

**EU CEFR Languages (24):**
Bulgarian, Croatian, Czech, Danish, Dutch, English, Estonian, Finnish, French, German, Greek, Hungarian, Irish, Italian, Latvian, Lithuanian, Maltese, Polish, Portuguese, Romanian, Slovak, Slovenian, Spanish, Swedish
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create language configuration and validation</name>
  <files>translation-backend/server.js</files>
  <action>
  Add a SUPPORTED_LANGUAGES constant with all 24 EU CEFR language codes and display names:
  ```javascript
  const SUPPORTED_LANGUAGES = {
    bg: 'Bulgarian', hr: 'Croatian', cs: 'Czech', da: 'Danish',
    nl: 'Dutch', en: 'English', et: 'Estonian', fi: 'Finnish',
    fr: 'French', de: 'German', el: 'Greek', hu: 'Hungarian',
    ga: 'Irish', it: 'Italian', lv: 'Latvian', lt: 'Lithuanian',
    mt: 'Maltese', pl: 'Polish', pt: 'Portuguese', ro: 'Romanian',
    sk: 'Slovak', sl: 'Slovenian', es: 'Spanish', sv: 'Swedish'
  };
  ```

  Add validation helper function:
  ```javascript
  function isValidLanguage(code) {
    return code && SUPPORTED_LANGUAGES[code.toLowerCase()];
  }
  function getLanguageName(code) {
    return SUPPORTED_LANGUAGES[code.toLowerCase()] || code;
  }
  ```

  Add a new `/languages` GET endpoint that returns the supported languages list.
  </action>
  <verify>curl http://localhost:3001/languages returns JSON with 24 language codes and names</verify>
  <done>SUPPORTED_LANGUAGES constant exists, validation helpers work, /languages endpoint returns all 24 EU languages</done>
</task>

<task type="auto">
  <name>Task 2: Generalize CEFR analysis prompt</name>
  <files>translation-backend/server.js</files>
  <action>
  Modify the `/analyze` endpoint (around line 626) to use the language parameter in the Claude prompt:

  1. Update validateAnalyzeRequest to validate language if provided (default to 'fr')
  2. Replace the hardcoded "French text" prompt with a template:
  ```javascript
  const languageName = getLanguageName(language);
  content: `Assess CEFR level (A1-C2) of ${languageName} text. Consider vocabulary complexity, grammar structures, sentence complexity.

${languageName} text:
"${sampled.text}"

Return ONLY valid JSON:
{"cefr_level":"B2","confidence":"high","vocabulary_examples":["word1","word2","word3"],"grammar_features":["feature1","feature2"],"reasoning":"Brief explanation"}`
  ```

  3. Pass `language` (defaulting to 'fr') through to the INSERT statement (line 674 already has language placeholder)

  Do NOT change the response structure - only the prompt text and database insert.
  </action>
  <verify>
  Test with French (default): curl -X POST http://localhost:3001/analyze -H "Content-Type: application/json" -d '{"text":"Le chat mange la souris dans le jardin."}'
  Test with Spanish: curl -X POST http://localhost:3001/analyze -H "Content-Type: application/json" -d '{"text":"El gato come el ratón en el jardín.","language":"es"}'
  Both should return CEFR analysis with appropriate language in response.
  </verify>
  <done>CEFR analysis works for any supported language, defaults to French, stores correct language in database</done>
</task>

<task type="auto">
  <name>Task 3: Generalize definition prompts</name>
  <files>translation-backend/server.js</files>
  <action>
  Modify both `/define` and `/define-batch` endpoints:

  1. In getClaudeDefinition() (line 783-830), replace hardcoded "French word" with language parameter:
  ```javascript
  async function getClaudeDefinition(word, context = '', language = 'fr') {
    const languageName = getLanguageName(language);
    // ... existing code ...
    content: `Define ${languageName} word "${word}"${context ? ` in context: "${context}"` : ''}. Provide the definition and translation in English. Return JSON:
{"definition":"... (in English)","translation":"... (in English)","cefr":"B2","type":"noun/verb/adj/adv/connector"}`
  }
  ```

  2. In `/define-batch` endpoint (line 990), replace hardcoded "French words":
  ```javascript
  const languageName = getLanguageName(language);
  content: `Define these ${languageName} words: ${wordsList}. Provide definitions and translations in English. Return JSON array:
[{"word":"word1","definition":"... (in English)","translation":"... (in English)","cefr":"B2","type":"noun"},...]`
  ```

  3. Keep the french_dictionary lookup but make it conditional:
  - If language === 'fr', query french_dictionary as fallback
  - For other languages, skip dictionary lookup and go straight to Claude

  Do NOT add new dictionary tables yet - Claude AI handles all languages.
  </action>
  <verify>
  Test French: curl -X POST http://localhost:3001/define -H "Content-Type: application/json" -d '{"word":"bonjour","language":"fr"}'
  Test Spanish: curl -X POST http://localhost:3001/define -H "Content-Type: application/json" -d '{"word":"hola","language":"es"}'
  Both should return definitions with appropriate language context.
  </verify>
  <done>/define and /define-batch work for any supported language, French still uses dictionary fallback, other languages use Claude directly</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `curl http://localhost:3001/languages` returns 24 languages
- [ ] `/analyze` works with French (default) and Spanish (explicit)
- [ ] `/define` works with French (uses dictionary fallback) and Spanish (uses Claude)
- [ ] `/define-batch` works with multiple languages
- [ ] Database stores correct language code in analyses table
- [ ] No TypeScript/JavaScript errors
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Backend accepts language parameter on all CEFR-related endpoints
- French remains default, other EU languages supported
- No breaking changes to existing French functionality
</success_criteria>

<output>
After completion, create `.planning/phases/02-multi-language-foundation/02-01-SUMMARY.md` with:

# Phase 2 Plan 01: Backend Language Generalization Summary

**[Substantive one-liner]**

## Accomplishments
- [Key outcomes]

## Files Created/Modified
- [List with descriptions]

## Decisions Made
- [Key decisions and rationale]

## Issues Encountered
- [Problems and resolutions, or "None"]

## Next Step
Ready for 02-02-PLAN.md (Extension language detection and UI)
</output>
